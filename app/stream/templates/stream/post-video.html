{% extends 'stream/base.html'%}
{% block content %}

{% load bootstrap5 %}
{% bootstrap_css %}
{% bootstrap_javascript %}
{% load static %}
<!DOCTYPE html>
<html data-bs-theme="light" lang="en">
    <style>
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .horizontal-buttons {
          flex-direction: row;
            display: flex;
        }

        .button {
          background-color: transparent;
          margin-bottom: 10px;
          padding: 10px;
          color: white;
          border: 1px solid white;
          text-align: center;
          text-decoration: none;
          display: inline-block;
          font-size: 16px;
          width: 75%; /* Set a width if needed */
          cursor: pointer; /* Mouse pointer on change to hand on hover */
        }

        .button:hover {
          background-color: #3e8e41;
        }

        .video-box{
            margin: 0 auto;
            width: 50%;
            height: 50%;
        }

        video {
            width: 100%;
            height: auto;
            display: block;
        }
      </style>
<head>
    <link rel="stylesheet" href="https://pyscript.net/releases/2022.12.1/pyscript.css" />
</head>
<body>
    <div style = "margin-top: 8em; padding-top: 10em;">
        <div class = "horizontal-buttons">
            <a class="button" href=" {% url 'stream:video-create' %}" style="color: #FFFFFF">
                Record
            </a>
            <a class="button" href=" {% url 'stream:video-upload' %}" style="color: #FFFFFF">
                Upload
            </a>
        </div>
        <h1 style="text-align: center; color: white;">Record a Video</h1>
        <div style = "padding-top: 2%;">
            <button id="start-camera" style="height: 50%; width: 50%; background-color: black; color: #FFFFFF; margin-bottom: 10%;">Start Camera</button>
            <div class="video-box" style="padding-bottom: 10%; display: none; margin-bottom:10%;">              
                <video id="video" width="320" height="240" autoplay></video>
            </div>
            <div class="horizontal-buttons">
                <button class="button" id="start-record">Start/Re-record</button>
                <button class="button" id="stop-record">Stop Recording</button>
                <button class="button">NEXT</button>
                <a class="button" id="download-video" download="test.webm" style="text-decoration: none; color: #FFFFFF">Download Video</a>
            </div>
        </div>
    </div>
    <script>
        let camera_button = document.querySelector("#start-camera");
        let video = document.querySelector("#video");
        let start_button = document.querySelector("#start-record");
        let stop_button = document.querySelector("#stop-record");
        let download_link = document.querySelector("#download-video");

        let camera_stream = null;
        let media_recorder = null;
        let blobs_recorded = [];

        camera_button.addEventListener('click', async function() {
            camera_stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            videobox = document.querySelector('.video-box');
            videobox.style.display = 'block';
            camera_button.style.display = 'none';
            video.srcObject = camera_stream;
        });

        start_button.addEventListener('click', function() {
            // set MIME type of recording as video/webm
            media_recorder = new MediaRecorder(camera_stream, { mimeType: 'video/webm' });

            // event : new recorded video blob available 
            media_recorder.addEventListener('dataavailable', function(e) {
                blobs_recorded.push(e.data);
            });

            // event : recording stopped & all blobs sent
            media_recorder.addEventListener('stop', function() {
                // create local object URL from the recorded video blobs
                let video_local = URL.createObjectURL(new Blob(blobs_recorded, { type: 'video/webm' }));
                download_link.href = video_local;
            });

            // start recording with each recorded blob having 1 second video
            media_recorder.start(1000);
        });

        stop_button.addEventListener('click', function() {
            media_recorder.stop(); 
        });
    </script>
</body>

        {% comment %} <div>
            <form method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <h1>Upload a video</h1>
                    {{ form.as_p }}
                <button class="btn btn-outline-info" type="submit">Upload</button>

            </form>
        </div> {% endcomment %}
        {% if user.is_authenticated %}
            <div id="overlay" class="float-center" style="position:fixed; top:30%;">
                <div>
                    <p class="text-dark">Are you sure to logout?</p>
                    <button id="logout" class="float-left submit-button" >Logout</button>
                    <button id="cancel" class="float-left submit-button">Cancel</button>
                </div>
            </div>
        {% endif %}
    </div>
{% endblock content %}

